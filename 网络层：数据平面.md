# 网络层：数据平面

## 4.1 网络层概述

每台路由器的数据平面的主要作用是从其输入链路向其输出链路转发数据报

控制平面的主要作用是协调这些本地的每路由器转发动作，使得数据报沿着源和目的地主机之间的路由器路径最终进行端到端出传送

### 4.1.1 转发和路由选择：数据平面和控制平面

- *转发*：当一个分组到达某路由器的一条输入链路时，该路由器必须将该分组移动到适当的输出链路。转发发生的时间尺度很短（通常为几那纳秒），因此通常用硬件来实现。
- *路由选择*：当分组从发送方流向接收方时，网络层必须决定这些分组所采用的路由或路径。计算这些路径的算法被称为路由选择算法。路由选择发生的时间尺度长得多（通常为几秒），因此通常用软件来实现。

每台网络路由器有一个关键元素就是转发表。路由器检查到达分组首部的一个或多个字段值，进而使用这些首部值在其转发表中索引，通过这种方法来转发分组。这些值对应存储在转发表中的项，指出了该分组将被转发的路由器的输出链路接口。

**控制平面：SDN方法**

![image-20210312163728276](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20210312163728276.png)

在图中，控制平面路由选择功能与物理的路由器是分离的，即路由选择设备仅执行转发，而远程控制器计算并分发转发表。远程控制器可能实现在具有高可靠性和冗余的远程数据中心中，并可能由ISP或某些第三方管理。

图中的控制平面方法是**软件定义网络（SDN）**的本质，因为计算转发表并与路由器交互的控制器是用软件实现的，故网络是“软件定义”的。

### 4.1.2 网络服务模型

**网络服务模型**定义了分组在发送与接收端系统之间的端到端运输特性

网络层能提供的某些可能的服务，包括：

- *确保交付*：该服务确保分组将最终达到目的地‘
- *具有时延上届的确保交付*：该服务不仅确保分组的交付，而且在特定的主机到主机时延上界内交付
- *有序分组交付*：该服务确保分组以它们发送的顺序到达目的地
- *确保最小带宽*：这种网络层服务模仿在发送和接收主机之间一条特定比特率的传输链路的行为。只要发送主机以低于特定比特率的速率传输比特，则所有分组最终会交付到目的主机
- *安全性*：网络层能够在源加密所有数据报并在目的地解密这些分组，从而对所有运输层报文段提供机密性

网络层提供了单一的服务，称为*尽力而为服务*。



- *分组交换机*：是指一台通用分组交换设备，它根据分组首部字段中的值，从输入链路接口到输出链路接口转移分组。
- 某些分组交换机称为**链路层交换机**，基于链路层帧中的字段值做出转发决定，这些交换机被称为链路层设备。
- 其他分组交换机称为**路由器**，基于网络层数据报中的首部字段值做出转发决定，因此路由器是网络层设备



## 4.2 路由器工作原理

![image-20210312214720812](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20210312214720812.png)

- *输入端口*：
  - 它在路由器中执行终结入物理链路的物理层功能
  - 它与位于入链路远端的数据链路层交互来执行数据链路层功能，
  - 输入端口要执行查找功能，通过查询转发表决定路由器的输出端口，到达的分组通过路由器的交换结构转发到输出端口
- *交换结构*：交换结构将路由器的输入端口连接到输出端口，这种交换结构完全包含在路由器之中，即它是一个网络路由器中的网络。
- *路由选择处理器*：路由选择处理器执行控制平面功能。在传统的路由器中，它执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表。在SDN路由器中，路由选择处理器负责与远程控制器通信，目的是接收由远程控制器计算的转发表项，并在路由器的输入端口安装这些表项



### 4.2.1 输入端口处理和基于目的地转发

![image-20210312222203585](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20210312222203585.png)

输入端口的线路端接功能与链路层处理实现了用于各个输入链路的物理层和链路层。

路由器使用转发表来查找输出端口，使得到达的分组能经过交换结构转发到该输出端口。

转发表是由路由选择器计算和更新的或者转发表接收来自远程SDN控制器的内容。

考虑“最简单”的情况，一个入分组基于该分组的目的地址交换到输出端口。

![image-20210312222500241](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20210312222500241.png)

使用这种风格的转发表，路由器用分组目的地址的前缀与该表中的表项进行匹配，如果存在一个匹配项，则路由器向该匹配项相关联的链路转发分组。

当有多个匹配时，该路由器使用最长前缀匹配规则：即在该表中寻找最长的匹配项，并向与最长前缀匹配相关联的链路接口转发分组。

### 4.2.2 交换

交换结构位于一台路由器的核心部分，因为正是通过这种交换结构，分组才能实际地从一个输入端口到一个输出端口中。交换可以用许多方式完成。

![image-20210312222904780](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20210312222904780.png)

- *经内存交换*：最简单、最早的路由器是传统的计算机，在输入端口与输出端口之间的交换是在CPU的直接控制下完成的。许多现代路由器通过内存进行交换，与早起路由器的一个主要差别是，目的地址的查找和将分组存储进适当的内存存储位置是由输入线路卡来处理的
- *经总线交换*：输入端口经一根共享总线将分组直接传送到输出端口，不需要路由选择器的干预
- *经互联网络交换*：克服单一、共享式总线带宽限制的一种方法是，使用一个更复杂的互联网络。

### 4.2.3 输出端口处理

![image-20210312223324061](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20210312223324061.png)

输出端口处理取出已经存放在输出端口内存中的分组并将其发送到输出链路上。这包括选择和取出排队的分组进行传输，执行所需的链路层和物理层传输功能。

R<sub>line</sub>