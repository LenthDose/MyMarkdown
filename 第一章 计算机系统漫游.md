# 第一章 计算机系统漫游

## 1.1 信息就是位+上下文

hello程序的生命周期是从一个源程序（或者说源文件开始的），即程序员通过编辑器创建并保存的文本文件，文件名是hello.c。

源程序实际上就是一个由值0和1组成的位序列，8个位被组织成一组，称为字节。每个字节表示程序中的某些文本字符。

hello程序是以字节序列的方式储存在文件中的。

## 1.2 程序被其他程序翻译成不同的格式

为了在系统上运行hello.c程序，每条C语句都必须被其他程序转化为一系列的低级机器语言指令，然后这些指令按照一种称为可执行目标程序的格式打好包，并以二进制磁盘文件的形式存放起来。目标程序也称为可执行目标文件。

在Unix系统上，从源文件到目标文件的转化是由编译器驱动程序完成的，这个翻译过程分为四个阶段完成，执行这四个阶段的程序一起构成了编译系统。

![image-20211208033512450](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033512450.png)

- 预处理阶段；预处理器（cpp）根据以字符#开头的命令，修改原始的C程序
- 编译阶段：编译器（ccl）将文本文件hello.i翻译成文本文件hello.s，它包含一个汇编语言程序
- 汇编阶段：汇编器（as）将hello.s翻译成机器语言指令，把这些指令打包成一种叫做可重定位目标程序的格式，并将结果保存在目标文件hello.o中。
- 链接阶段：链接器（ld）负责处理将print函数存在于的printf.o的单独的预编译文件中合并到hello.o程序中，结果得到hello文件，它是一个可执行目标文件，可以被加载到内存中，由系统执行



## 1.4 处理器读并解释存储在内存中的指令

### 1.4.1 系统的硬件组成

![image-20211208033545832](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033545832.png)

***1.总线***

贯穿整个系统的是一组电子管道，称作总线，它携带信息字节并负责在各个部件间传递。通常总线被设计成传送定长的字节块，也就是字。字中的字节数是一个基本的系统参数，各个系统中都不尽相同。

***2.I/O设备***

I/O设备是系统与外部世界的联系通道。每个I/O设备都通过一个控制器或适配器与I/O总线相连。区别在于它们的封装方式，控制器是I/O设备本身或者系统的主印制电路板上的芯片组，而适配器是一块插在主板插槽上的卡

***3.主存***

*主存*是一个临时存储设备，在处理器执行程序时，用来存放程序和程序处理的数据。从物理上来说，主存是由一组动态随机存取存储器（DRAM）芯片组成的。从逻辑上来说，存储器是一个线性的字节数组，每个字节都有其唯一的地址（数组索引），这些地址是从零开始的。

***4.处理器***

中央处理单元（CPU），简称处理器，是解释（或执行）存储在主存中指令的引擎。*处理器的核心是一个大小为一个字的存储设备（或寄存器），称为程序计数器（PC）。在任何时刻，PC都指向主存中的某条机器语言指令（即含有该条指令的地址）。*

从系统通电开始，直到系统断电，处理器一直在不断地执行程序计数器指向的指令，再更新程序计数器，使其指向下一条指令。

处理器看上去是按照一个非常简单的指令执行模型来操作的，这个模型是由指令集架构决定的。

寄存器文件是一个小的存储设备，由一些单个字长的寄存器组成，每个寄存器都由唯一的名字。ALU（算术/逻辑单元）计算新的数据和地址值。CPU在指令的要求下可能会执行这些操作：加载、存储、操作、跳转

### 1.4.2运行hello程序

![image-20211208033605160](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033605160.png)

![image-20211208033614498](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033614498.png)

![image-20211208033625637](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033625637.png)

## 1.5 高速缓存

针对处理器与主存之间的差异，采用了更小更快的存储设备，称为高速缓存存储器（cache memory），作为暂时的集结区域，存放处理器近期可能会需要的信息。L1和L2高速缓存是用一种叫做静态随机访问存储器（SRAM）的硬件技术实现的。

![image-20211208033646033](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033646033.png)

## 1.6 存储设备形成层次结构

每个计算机系统中的存储设备都被组织成了一个存储器层次结构

![image-20211208033658715](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033658715.png)

## 1.7 操作系统管理硬件

可以把操作系统看成是应用程序和硬件之间插入的一层软件，所有应用程序对硬件的此操作都必须通过操作系统。

操作系统由两个基本功能：

- 防止硬件被失控的应用程序滥用
- 向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备。

操作系统通过几个基本的抽象概念（进程、虚拟内存和文件）来实现这两个功能。

文件是对I/O设备的抽象表示，虚拟内存是对主存和磁盘I/O设备的抽象表示，进程则是对处理器、主存和I/O设备的抽象表示。

![image-20211208033718761](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033718761.png)



### 1.7.1 进程

进程是操作系统对一个正在运行的程序的一种手写。在一个系统上可以同时运行多个进程，而每个进程都好像在独占地使用硬件。

*并发运行*则是在说一个进程的指令和另一个进程的指令是交错进行的。

无论是在单核还是在多核系统中，一个CPU看上去都像是在并发地执行多个进程，这是通过处理器在进程间切换来实现的。操作系统实现这种交错执行的机制称为上下文切换。

操作系统保持跟踪进程运行所需的所有状态信息。这种状态，也就是*上下文*，包括许多信息：比如PC和寄存器文件的当前值，以及主存的内容。

从一个进程到另一个进程的切换是由操作系统内核管理的。内核是操作系统代码常驻主存的部分。

![image-20211208033733652](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033733652.png)

### 1.7.2 线程

在现代系统中，一个进程实际上可以由多个称为*线程*的执行单元组成，每个线程都运行在进程的上下文中，并共享同样的代码和全局数据

### 1.7.3 虚拟内存

*虚拟内存*是一个抽象概念，它为每个进程提供了一个假象，即每个进程都在独占地使用主存。每个进程看到的内存都是一致的，称为*虚拟地址空间*

![image-20211208033749280](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033749280.png)

- 程序代码和数据：对所有的进程来说，代码是从同一固定地址开始，紧接着是和C全局变量相对的数据位置。代码和数据区是直接按照可执行目标文件的内容初始化的。
- 堆：堆可以在运行时动态地扩展和收缩
- 共享库：大约在地址空间的中间部分是一块用来存放像C标准库和数学库这样的共享库的代码和数据的区域
- 栈：编译器用栈来实现函数调用，用户栈在程序执行期间可以动态地扩展和收缩
- 内核虚拟内存：地址空间顶部的区域是为内核保留的。不允许应用程序读写这个区域的内容或者直接调用内核代码定义的函数。相反，它们必须调用内核来执行这些操作

### 1.7.4 文件

文件就是字节序列，每个I/O设备，包括磁盘、键盘、显示器，甚至网络，都可以看成是文件。系统中的所有输入输出都是通过使用一小组称为Unix I/O的系统函数调用读写文件来实现的。

## 1.8 系统之间利用网络通信

当系统从主存复制一串字节到网络适配器时，数据流经过网络到达另一台机器，而不是比如说到达本地磁盘驱动器。相似地，系统可以读取从其他机器发送来的数据，并把数据复制到自己的主存。

![image-20211208033801549](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033801549.png)

## 1.9 重要主题

### 1.9.1 Amdahl定律

定律：当我们对系统的某个部分加速时，其对系统整体性能的影响取决于该部分的重要性和加速度。

若系统执行某应用程序需要时间为T<sub>old</sub>，假设系统某部分所需执行时间与该时间的比例为α，而该部分性能提升比例为k。即该部分初始所需时间为αT<sub>old</sub>，现在所需时间为(αT<sub>old</sub>)/k。因此，总的执行时间为T<sub>new</sub>=(1-α)T<sub>old</sub>+(αT<sub>old</sub>)/k=T<sub>old</sub>[(1-α)+α/k]，可以计算加速比S=T<sub>old</sub>/T<sub>new</sub>=1/(1-α)+α/k

### 1.9.2 并发和并行

**1.线程级并发**

并发是一个通用的概念，指一个同时具有多个活动的系统；

并行指的是用并发来使一个系统运行得更快。并行可以在计算机系统的多个抽象层次上运用

![image-20211208033836552](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033836552.png)

超线程：有时称为同时多线程，是一项允许一个CPU执行多个控制流的技术。

**2.指令级并行**

在较低的抽象层次上，现代处理器可以同时执行多条指令的属性称为指令级并行。

如果处理器可以达到比一个周期一条指令更快的执行速率，就称之为超标量处理器。

**3.单指令、多数据并行**

在最低层次上，许多现代处理器拥有特殊的硬件，允许一条指令产生多个可以并行执行的操作，这种方式称为单指令、多数据，即SIMD并行。

提供这些SIMD指令多是为了提高处理影像、声音和视频数据应用的执行速度。

### 1.9.3 计算机系统中抽象的重要性

![image-20211208033848390](C:\Users\Silhouette76\AppData\Roaming\Typora\typora-user-images\image-20211208033848390.png)

